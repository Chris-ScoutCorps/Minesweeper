<!DOCTYPE HTML>
<html>
    <head>
        <title>Minesweeper</title>
        <style type="text/css">
            #mines {
                cursor: default
            }

            td {
                width: 18px;
                height: 18px;
                border-radius: 5px;
                -moz-border-radius: 5px;
                -webkit-border-radius: 5px;
                text-align: center;
                vertical-align: middle;
                font-weight: bold;
                font-size: 15px;
                line-height: 15px;
            }
            td.unclicked {
                background-color: #ddd;
                border-top: 1px solid rgba(0,0,0,0.2);
                border-left: 1px solid rgba(0,0,0,0.2);
                border-right: 2px solid rgba(0,0,0,0.2);
                border-bottom: 2px solid rgba(0,0,0,0.2);
            }
            td.unclicked:hover {
                background-color: #ccc;
                border-color: rgba(0,0,0,0.5);
            }
            td.unclicked:active, td.clicked {
                background-color: #aaa;
                border-top: 2px solid rgba(0,0,0,0.2);
                border-left: 2px solid rgba(0,0,0,0.2);
                border-right: 1px solid rgba(0,0,0,0.2);
                border-bottom: 1px solid rgba(0,0,0,0.2);
            }
            td.mine {
                background-color: #D11;
            }
        </style>
    </head>
<body>
    <table id="mines" unselectable="on"></table>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript">
        /* TODO:
        * flag counter
        * win
        * lose
        * restart / settings
        *
        * probabilities + show/hide
        *
        * color numbers
        * add icons
        */

        const rows = 20;
        const cols = 30;
        const mines = 80;
        var state;

        const FLAG = Object.freeze({
            SET: { icon: '>' },
            QUESTION: { icon: '?' }
        });

        function series(len) {
            var a = [];
            for (var i=0; i<len; i++)
                a.push(i);
            return a;
        }

        const MineID = Object.freeze({
            get: function (row, col) {
                return row + '-' + col;
            },
            parse: function (id) {
                var s = id.split('-');
                return {
                    row: parseInt(s[0]),
                    col: parseInt(s[1])
                }
            }
        });

        function getRandomMine() {
            return MineID.get(
                Math.floor(Math.random() * rows),
                Math.floor(Math.random() * cols)
            );
        }

        function buildState() {
            var mineLocations = {};
            var clicked = {};
            var flags = {};
            var playing = true;

            while (Object.keys(mineLocations).length < mines) { //hash to avoid dupes
                mineLocations[getRandomMine()] = true;
            }

            return {
                playing: playing,
                isMine: function (id) {
                    return mineLocations[id] || false;
                },
                setClicked: function (id) {
                    clicked[id] = true;
                },
                isClicked: function (id) {
                    return clicked[id] || false;
                },
                toggleFlag: function (id) {
                    if (!flags[id]) flags[id] = FLAG.SET;
                    else if (flags[id] === FLAG.SET) flags[id] = FLAG.QUESTION;
                    else delete flags[id];

                    return flags[id] || false;
                },
                getFlag: function (id) {
                    return flags[id] || false;
                },
                didWin: function () {
                    return Object.keys(clicked).length === ((rows * cols) - mines);
                }
            };
        }
        state = buildState();

        function getAdjacent(id) {
            var p = MineID.parse(id);
            return [
                { row: p.row - 1, col: p.col },
                { row: p.row - 1, col: p.col + 1 },
                { row: p.row, col: p.col + 1 },
                { row: p.row + 1, col: p.col + 1 },
                { row: p.row + 1, col: p.col },
                { row: p.row + 1, col: p.col - 1 },
                { row: p.row, col: p.col - 1 },
                { row: p.row - 1, col: p.col - 1 }
            ].filter(function (x) {
               return x.row >= 0 && x.col >= 0 && x.row < rows && x.col < cols;
            }).map(function (a) {
                return MineID.get(a.row, a.col);
            });
        }
        
        function activate(square) {
            const id = square.attr('data-mineid');

            if (state.getFlag(id)) {
                return;
            }

            square.removeClass('unclicked');
            state.setClicked(id);
            if (state.isMine(id)) {
                square.addClass('mine');
                displayEnding(false);
                return;
            }
            else {
                square.addClass('clicked');
            }

            if (state.didWin()) {
                displayEnding(true);
                return;
            }

            const adjacent = getAdjacent(id);
            const adjMines = adjacent.filter(function (a) {
                return state.isMine(a);
            }).length;

            if (adjMines) {
                square.html(adjMines);
            }
            else {
                setTimeout(function () {
                    adjacent.forEach(function (a) {
                        if (!state.isClicked(a)) {
                            activate($('td[data-mineid=' + a + ']'));
                        }
                    });
                }, 15);
            }
        }

        function displayEnding(won) {
            state.playing = false;

            if (!won) {
                $('td', '#mines').each(function () {
                    const mineid = $(this).attr('data-mineid');
                    if (state.isMine(mineid)) {
                        setTimeout(function () {
                            $('td[data-mineid=' + mineid + ']').html('*');
                        }, Math.floor(Math.random() * 500));
                    }
                })
            }

            setTimeout(function () {
                alert(won ? 'Victory!' : 'Defeat!');
            }, won ? 100 : 510);
        }

        $(document).ready(function () {
            series(rows).forEach(function (r) {
                var row = $('<tr></tr>');
                series(cols).forEach(function (c) {
                   var col = $('<td></td>');
                   col.addClass('unclicked');
                   var mid = MineID.get(r, c);
                   col.attr('data-mineid', mid);
                   row.append(col);
                });
                $('#mines').append(row);
            });

            $('td', '#mines').mouseup(function (event) {
                const mineid = $(this).attr('data-mineid');
                if (!state.isClicked(mineid) && state.playing) {
                    if (event.which === 1) {
                        activate($(this));
                    }
                    else {
                        const flag = state.toggleFlag(mineid);
                        $(this).html(flag ? flag.icon : '');
                    }
                }
            });

            $('td', '#mines').dblclick(function () {
                const id = $(this).attr('data-mineid');
                if (state.isClicked(id) && state.playing) {
                    const adjacent = getAdjacent(id);

                    const adjMines = adjacent.filter(function (a) {
                        return state.isMine(a);
                    }).length;
                    const adjFlags = adjacent.filter(function (a) {
                        return state.getFlag(a) === FLAG.SET;
                    }).length;

                    if (adjFlags && adjFlags === adjMines) {
                        adjacent.forEach(function (a) {
                           if (!state.getFlag(a)) {
                               activate($('td[data-mineid=' + a + ']'));
                           }
                        });
                    }
                }
            });

            $('#mines').on('contextmenu', false);
            $('#mines').on('selectstart', false);
        });
    </script>
</body>
</html>